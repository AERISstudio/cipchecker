<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>자습실 선택 및 CIP 선택</title>
    <link rel="'stylesheet" href="/static/CSS/cip.css">
    
    <!-- ✅ Firebase SDK 로드 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

        // ✅ Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyCno_36Bl-DqjEk12lmFranNylngoo8Sd8",
            authDomain: "dshs-cip.firebaseapp.com",
            databaseURL: "https://dshs-cip-default-rtdb.firebaseio.com", 
            projectId: "dshs-cip",
            storageBucket: "dshs-cip.appspot.com",
            messagingSenderId: "1033758614768",
            appId: "1:1033758614768:web:6cc73592e6b9052fdfd4e35",
            measurementId: "G-V8X4BKESWM"
        };

        // ✅ Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // ✅ 현재 자습실1의 인원 수 가져오기
        async function updateRoomCapacity() {
            const roomRef = ref(database, "rooms/자습실/자습실1");
            try {
                const snapshot = await get(roomRef);
                if (snapshot.exists()) {
                    const roomData = snapshot.val();
                    const currentCapacity = roomData.current_capacity ?? 0;
                    const maxCapacity = roomData.max_capacity || 30;
                    document.getElementById("roomCapacity").innerText = `현재 인원: ${currentCapacity} / ${maxCapacity}`;
                } else {
                    document.getElementById("roomCapacity").innerText = "현재 인원 데이터를 불러올 수 없습니다.";
                }
            } catch (error) {
                console.error("자습실 인원 수 업데이트 오류:", error);
            }
        }

        // ✅ 자습실1 선택 + CIP 선택 통합 함수
        window.submitSelection = async function () {
            try {
                // ✅ CIP 선택 확인
                
                const cip2 = document.getElementById("cip2").checked ? "자습실1" : "자습";
                const cip3 = document.getElementById("cip3").checked ? "자습실1" : "자습";

                // ✅ 현재 자습실1 인원 확인
                const roomRef = ref(database, "rooms/자습실/자습실1");
                const snapshot = await get(roomRef);

                if (snapshot.exists()) {
                    let roomData = snapshot.val();
                    let currentCapacity = roomData.current_capacity ?? 0;
                    let maxCapacity = roomData.max_capacity || 30;

                    if (currentCapacity >= maxCapacity) {
                        alert("⚠️ 자습실1이(가) 이미 가득 찼습니다!");
                        return;
                    }

                    // 🔥 Firebase 인원 업데이트
                    await update(roomRef, { current_capacity: currentCapacity + 1 });

                    // 🔥 Flask 서버에 CIP 선택 정보 전송
                    const response = await fetch("/update_select", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ cip2, cip3 })
                    });

                    const data = await response.json();
                    if (data.error) {
                        alert("⚠️ " + data.error);
                    } else {
                        alert("✅ 선택이 저장되었습니다!");
                        updateRoomCapacity(); // 인원 업데이트 후 다시 갱신
                    }
                } else {
                    alert("⚠️ 공간 정보를 찾을 수 없습니다!");
                }
            } catch (error) {
                console.error("선택 저장 오류:", error);
                alert("❌ 오류가 발생했습니다. 다시 시도해주세요.");
            }
        };

        window.onload = updateRoomCapacity;
    </script>
</head>
<body>
    <h2 style="display: flex; justify-content: center; ">CIP 선택</h2>
    <span  style="display: flex; justify-content: center;" id="roomCapacity">현재 인원: 불러오는 중...</span>>
    <label class="text-center" style="display: flex; justify-content: center; position: relative;">
        <input type="checkbox" id="cip2">
        <img id="img-cip2" src="/static/Image/On.png">
        <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #6c6c6c; font-size: 20px; font-weight: bold;">
            CIP 2차
        </span>
    </label>
    <br/>
    <label style="display: flex; justify-content: center; position: relative;">
        <input type="checkbox" id="cip3">
        <img id="img-cip3" src="/static/Image/On.png">
        <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #6c6c6c; font-size: 20px; font-weight: bold;">
            CIP 3차
        </span>
    </label>
    
    <br/>
    <div style="display: flex; justify-content: center;">
        <button id="submitBtn" style="box-shadow: none; border: none; background-color: rgba(240, 248, 255, 0);" onclick="submitSelection()" disabled>
            <img id="btn-img" src="/static/Image/Component 2.png">
        </button>
    </div>
    
    <script>
        function updateButtonState() {
            const cip2Checked = document.getElementById('cip2').checked;
            const cip3Checked = document.getElementById('cip3').checked;
            const button = document.getElementById('submitBtn');
            const btnImg = document.getElementById('btn-img');
    
            if (cip2Checked || cip3Checked) {
                btnImg.src = '/static/Image/CP2x.png'; // 체크되면 버튼 이미지 변경
                button.disabled = false; // 버튼 활성화
            } else {
                btnImg.src = '/static/Image/Component 2.png'; // 체크 해제되면 원래 이미지
                button.disabled = true; // 버튼 비활성화
            }
        }
    
        document.getElementById('cip2').addEventListener('change', function () {
            document.getElementById('img-cip2').src = this.checked ? '/static/Image/Off.png' : '/static/Image/On.png';
            updateButtonState();
        });
    
        document.getElementById('cip3').addEventListener('change', function () {
            document.getElementById('img-cip3').src = this.checked ? '/static/Image/Off.png' : '/static/Image/On.png';
            updateButtonState();
        });
    
        function submitSelection() {
            alert("제출 완료!");
        }
    </script>
</body>
</html>
