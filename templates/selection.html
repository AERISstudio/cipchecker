<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ììŠµì‹¤ ì„ íƒ</title>
    
    <!-- âœ… Firebase SDK ë¡œë“œ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

        // âœ… Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyCno_36Bl-DqjEk12lmFranNylngoo8Sd8",
            authDomain: "dshs-cip.firebaseapp.com",
            databaseURL: "https://dshs-cip-default-rtdb.firebaseio.com", 
            projectId: "dshs-cip",
            storageBucket: "dshs-cip.appspot.com",
            messagingSenderId: "1033758614768",
            appId: "1:1033758614768:web:6cc73592e6b9052fdfd4e35",
            measurementId: "G-V8X4BKESWM"
        };

        // âœ… Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // âœ… í˜„ì¬ ììŠµì‹¤1ì˜ ì¸ì› ìˆ˜ ê°€ì ¸ì˜¤ê¸°
        async function updateRoomCapacity() {
            const roomRef = ref(database, "rooms/ììŠµì‹¤/ììŠµì‹¤1");
            const snapshot = await get(roomRef);

            if (snapshot.exists()) {
                const roomData = snapshot.val();
                const currentCapacity = roomData.current_capacity || 0;
                document.getElementById("roomCapacity").innerText = `í˜„ì¬ ì¸ì›: ${currentCapacity} / 30`;
            } else {
                document.getElementById("roomCapacity").innerText = "í˜„ì¬ ì¸ì› ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            }
        }

        window.submitChoice = async function () {
            const cip1 = document.getElementById("cip1").value;
            const cip2 = document.getElementById("cip2").value;
            const cip3 = document.getElementById("cip3").value;

            try {
                // ğŸ”¥ í˜„ì¬ ê³µê°„ì˜ ì¸ì› ê°€ì ¸ì˜¤ê¸°
                const roomRef = ref(database, "rooms/ììŠµì‹¤/ììŠµì‹¤1");
                const snapshot = await get(roomRef);

                if (snapshot.exists()) {
                    let roomData = snapshot.val();
                    let currentCapacity = roomData.current_capacity || 0;
                    let maxCapacity = roomData.max_capacity || 0;

                    if (currentCapacity >= maxCapacity) {
                        alert(`âš ï¸ ììŠµì‹¤1ì´(ê°€) ì´ë¯¸ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤!`);
                        return;
                    }

                    // ğŸ”¥ Firebase ì¸ì› ì—…ë°ì´íŠ¸
                    await update(roomRef, { current_capacity: currentCapacity + 1 });

                    // ğŸ”¥ Flask ì„œë²„ì—ë„ CIP ì„ íƒ ì‚¬í•­ì„ ì „ì†¡í•˜ì—¬ ì—‘ì…€ ì—…ë°ì´íŠ¸
                    const response = await fetch("/update_selection", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            selected_room: "ììŠµì‹¤1",
                            cip1: cip1,
                            cip2: cip2,
                            cip3: cip3
                        })
                    });

                    const data = await response.json();
                    if (data.error) {
                        alert("âš ï¸ " + data.error);
                    } else {
                        alert("âœ… " + data.message);
                        updateRoomCapacity(); // ì¸ì› ì—…ë°ì´íŠ¸ í›„ ë‹¤ì‹œ ê°±ì‹ 
                    }
                } else {
                    alert("âš ï¸ ê³µê°„ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
                }
            } catch (error) {
                console.error("ì˜¤ë¥˜ ë°œìƒ:", error);
            }
        };

        window.onload = updateRoomCapacity;
    </script>
</head>
<body>
    <h2>ììŠµì‹¤ ì„ íƒ</h2>

    <button onclick="submitChoice()">ììŠµì‹¤1 ì„ íƒ</button>
    <span id="roomCapacity">í˜„ì¬ ì¸ì›: ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>

    <h3>ì„¸ë¶€ í™œë™ ì„ íƒ</h3>
    <label for="cip1">CIP1:</label>
    <select id="cip1">
        <option value="ììŠµ">ììŠµ</option>
        <option value="í™œë™ì‹¤">í™œë™ì‹¤</option>
        <option value="ìˆ˜í–‰ì‹¤">ìˆ˜í–‰ì‹¤</option>
    </select>

    <label for="cip2">CIP2:</label>
    <select id="cip2">
        <option value="ììŠµ">ììŠµ</option>
        <option value="í™œë™ì‹¤">í™œë™ì‹¤</option>
        <option value="ìˆ˜í–‰ì‹¤">ìˆ˜í–‰ì‹¤</option>
    </select>

    <label for="cip3">CIP3:</label>
    <select id="cip3">
        <option value="ììŠµ">ììŠµ</option>
        <option value="í™œë™ì‹¤">í™œë™ì‹¤</option>
        <option value="ìˆ˜í–‰ì‹¤">ìˆ˜í–‰ì‹¤</option>
    </select>

</body>
</html>
