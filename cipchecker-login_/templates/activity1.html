<!DOCTYPE html>
<html lang="kr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹œê°„ ì„ íƒ</title>
    <link rel="stylesheet" href="../static/CSS/cip.css">
</head>
<body>
    <div style="text-align: center; position: relative; color: black; font-size: 73.16px; font-family: 'GmarketSansTTFBold'; font-weight: 500; word-wrap: break-word">í•™ìŠµì‹¤ 1</div>
    <div style="display: flex; justify-content: center; align-items: center; height: 100%; flex-direction: column; text-align: center;">
        <a>
            <button class="toggle-btn" style="background-color: rgba(240, 248, 255, 0); border: 0px rgb(255, 255, 255) solid;" onclick="toggleImage(2)">
                <div style="position: relative; display: inline-block; width: 600px; height: 100px;">
                    <img id="toggleImg2" src="../static/Image/On.png" alt="CIP 2ì°¨" style="width: 100%; height: 100%; border-radius: 5px;">
                    <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #6c6c6c; font-size: 20px; font-weight: bold;">
                        CIP 2ì°¨
                    </span>
                </div>
            </button>
        </a>
        <br>
        <a>
            <button class="toggle-btn" style="background-color: rgba(240, 248, 255, 0); border: 0px rgb(255, 255, 255) solid;" onclick="toggleImage(3)">
                <div style="position: relative; display: inline-block; width: 600px; height: 100px;">
                    <img id="toggleImg3" src="../static/Image/On.png" alt="CIP 3ì°¨" style="width: 100%; height: 100%; border-radius: 5px;">
                    <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #6c6c6c; font-size: 20px; font-weight: bold;">
                        CIP 3ì°¨
                    </span>
                </div>
            </button>
        </a>
        <br>
        <a id="successLink" href="/Success.html" onclick="return checkLinkStatus(event);">
            <button style="background-color: rgba(255, 0, 0, 0); border: 0px;">
                <div>
                    <img id="componentImg" src="../static/Image/Component 2.png">
                </div>
            </button>
        </a>

         <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

        // âœ… Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyCno_36Bl-DqjEk12lmFranNylngoo8Sd8",
            authDomain: "dshs-cip.firebaseapp.com",
            databaseURL: "https://dshs-cip-default-rtdb.firebaseio.com", 
            projectId: "dshs-cip",
            storageBucket: "dshs-cip.appspot.com",
            messagingSenderId: "1033758614768",
            appId: "1:1033758614768:web:6cc73592e6b9052fdfd4e35",
            measurementId: "G-V8X4BKESWM"
        };

        // âœ… Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // âœ… í˜„ì¬ í™œë™ì‹¤1ì˜ ì¸ì› ìˆ˜ ê°€ì ¸ì˜¤ê¸°
        async function updateRoomCapacity() {
            const roomRef = ref(database, "rooms/í™œë™ì‹¤/í™œë™ì‹¤1");
            try {
                const snapshot = await get(roomRef);
                if (snapshot.exists()) {
                    const roomData = snapshot.val();
                    const currentCapacity = roomData.current_capacity ?? 0;
                    const maxCapacity = roomData.max_capacity || 30;
                    document.getElementById("roomCapacity").innerText = `í˜„ì¬ ì¸ì›: ${currentCapacity} / ${maxCapacity}`;
                } else {
                    document.getElementById("roomCapacity").innerText = "í˜„ì¬ ì¸ì› ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                }
            } catch (error) {
                console.error("í™œë™ì‹¤ ì¸ì› ìˆ˜ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", error);
            }
        }

        // âœ… í™œë™ì‹¤1 ì„ íƒ + CIP ì„ íƒ í†µí•© í•¨ìˆ˜
        window.submitSelection = async function () {
            try {
                // âœ… CIP ì„ íƒ í™•ì¸
                
                const cip2 = document.getElementById("cip2").checked ? "í™œë™ì‹¤1" : "ììŠµ";
                const cip3 = document.getElementById("cip3").checked ? "í™œë™ì‹¤1" : "ììŠµ";

                // âœ… í˜„ì¬ í™œë™ì‹¤1 ì¸ì› í™•ì¸
                const roomRef = ref(database, "rooms/í™œë™ì‹¤/í™œë™ì‹¤1");
                const snapshot = await get(roomRef);

                if (snapshot.exists()) {
                    let roomData = snapshot.val();
                    let currentCapacity = roomData.current_capacity ?? 0;
                    let maxCapacity = roomData.max_capacity || 30;

                    if (currentCapacity >= maxCapacity) {
                        alert("âš ï¸ í™œë™ì‹¤1ì´(ê°€) ì´ë¯¸ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤!");
                        return;
                    }

                    // ğŸ”¥ Firebase ì¸ì› ì—…ë°ì´íŠ¸
                    await update(roomRef, { current_capacity: currentCapacity + 1 });

                    // ğŸ”¥ Flask ì„œë²„ì— CIP ì„ íƒ ì •ë³´ ì „ì†¡
                    const response = await fetch("/update_select", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ cip2, cip3 })
                    });

                    const data = await response.json();
                    if (data.error) {
                        alert("âš ï¸ " + data.error);
                    } else {
                        alert("âœ… ì„ íƒì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
                        updateRoomCapacity(); // ì¸ì› ì—…ë°ì´íŠ¸ í›„ ë‹¤ì‹œ ê°±ì‹ 
                    }
                } else {
                    alert("âš ï¸ ê³µê°„ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
                }
            } catch (error) {
                console.error("ì„ íƒ ì €ì¥ ì˜¤ë¥˜:", error);
                alert("âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            }
        };

        window.onload = updateRoomCapacity;
    </script>
        
        <script>
            function toggleImage(num) {
                var img = document.getElementById("toggleImg" + num);
                if (img.src.includes("On.png")) {
                    img.src = "../static/Image/Off.png";
                } else {
                    img.src = "../static/Image/On.png";
                }
                checkCIPStatus();
            }

            function checkCIPStatus() {
                var img2 = document.getElementById("toggleImg2").src;
                var img3 = document.getElementById("toggleImg3").src;
                
                if (!img2.includes("Off.png") && !img3.includes("Off.png")) {
                    document.getElementById("componentImg").src = "../static/Image/Component 2.png";
                } else {
                    document.getElementById("componentImg").src = "../static/Image/CP2x.png";
                }
            }

            function checkLinkStatus(event) {
                var img2 = document.getElementById("toggleImg2").src;
                var img3 = document.getElementById("toggleImg3").src;
                
                // ëª¨ë‘ On ìƒíƒœì¼ ê²½ìš° ë§í¬ ì´ë™ì„ ë§‰ìŒ
                if (!img2.includes("Off.png") && !img3.includes("Off.png")) {
                    event.preventDefault();
                    return false;
                }
                return true; // í•˜ë‚˜ë¼ë„ Off ìƒíƒœë©´ ë§í¬ ì´ë™ í—ˆìš©
            }
        </script>
    </div>
</body>
</html>